# 大规模实例级权限限制

## 结论

> 接入系统需要评估现有权限模型, 对于使用`新建关联接口`和`实例授权接口`的权限管理进行 review, 合理需要确认加白名单, 不合理需要尽早变更权限模型!

**规则红线**: 所有产品形成共识, 定下`红线`, 要么修改权限管理为`范围授权`, 要么在确认单个人实例权限不会超过 10000 个的前提下使用现有的`新建关联`及`实例授权`; 如果都没有做而是暴力调用接口进行`大规模实例授权`, 那么`超过10000个之后, 接口报错, 需要接入系统自己解决(查询/合并/回收等)`

---

当前限制:
- `1个人拥有1个操作 + 1个资源类型`的实例权限最大数量：`10000`个。(触发后, 授权接口报错/用户无法继续增加实例权限) (**当前是 10000 个, 可能会降低配额, 待定**)
- 个人从无权限跳转`单次`申请数量限制：20 个（跳转过来超过 20 个，实例还是选中，点击提交按钮，提示用户超限）
- 个人 web 页面`单次`申请数量限制：20 个（超过 20 个，实例可以选中，点击提交按钮，提示用户超限）
- 个人的`新建关联接口`/`实例授权接口` 限制：20 个(**当前是 200, 会发版降低为 20 个**)

注意:
- 个人总数超 10000，接口报错提示：用户[username]的[action]操作关联的[resource_type]的实例数已达上限 10000 个，请改用范围或者属性授权。
- 单次超过限制提示：单次申请限 xx 个实例，实例权限数过多不利于您后期维护，更多实例建议您申请范围权限。

-----

## 1. 背景

权限中心是基于 ABAC 建立的权限体系, 目的是以最灵活的方式支持不同系统的各种权限管理场景.

当前, 权限中心支持`有限制`的实例授权
- 权限中心支持`实例级别`的权限管理, 可以在申请页面单独申请某些实例的权限. 例如: 单独申请某个主机的查看权限
- 申请页面最多一次批量申请`20`个实例权限
- 当前支持单个人单个操作最多`10000`个实例

由于各个系统的需求, 权限中心提供了`新建关联权限接口`(新建一个实例后自动拥有增删改查等权限)和`实例授权接口`(接入系统可以主动授权)

导致目前部分系统`误用`了这两个接口, 进行`大规模实例授权`, 导致会很快触发单个人单个操作`10000`个实例的规则. 届时, 接入系统给这个人所有授权相关操作都会报错.

核心矛盾:
- 设计之初, 目标就是`范围授权`, 以及`有限制的实例授权`, 不可能支持无限制的实例授权(目前限制单个人单个操作 10000 实例)
- 接入系统, 更多会直接以最简单的模型对接, 而不是评估权限模型的合理性, 导致大规模实例授权的存在!

本质上:
- 权限中心只支持`范围授权`, 以及`有限制的实例授权`
- 每个人超过 10000 个以上的实例权限管理放任何系统实现都是一个复杂的方案(单个资源类型的权限关系表可能十万/百万级的数据量), 而且对应系统产品上如何管理单个人的 10000 个以上实例权限也是一个问题. 所以更不应该认为现有权限中心能支持`无限制的实例权限`管理

---

## 2. 当前面临的问题

接入系统在进行权限接入时, 没有进行仔细的评估, 对产品的权限模型没有进行深入的考虑, 而是以最简单直接的方式, 调用`新建关联接口`和`实例授权接口`实现业务逻辑(这样的开发成本最低, 但是会带来问题)

例如:
- 导入 2000 台主机, 直接遍历 2000 台主机给这个用户逐一授权;
- 一个任务模板, 每执行一次, 就生成一个实例, 将这个实例给这个用户授权; 
- 在 5000 台主机上授权脚本的可执行权限, 遍历逐一授权

带来的问题:
- **权限无法管理**, 最终这批数据变成`三不管`
    - 个人无法管理: 在`我的权限`看到`主机查看`权限的实例有 10000 台主机
    - 接入系统无法管理: 授权后, 主机变更/人员变更等等带来的变化无法同步变更对应权限
    - 权限中心无法管理: 本质上权限中心只做存储和展示, 变更由用户通过界面或接入系统通过 API 操作
- 个人策略过大
    - 策略查询给权限中心/redis/mysql 带来很大的压力, 1W 个 ID 约 100KB, 整体策略可能上`M`;
    - 网络传输数据量变大
    - 接入系统鉴权`慢`, 因为计算量变大

---

## 3. 当前新接入系统哪些触发了限制

**具体还是需要各个产品自行评估**

---

## 4. 怎么解决这个问题

> 所有系统应该以`符合新版权限中心要求`的权限模型接入, 而不是沿袭原先简单粗暴的接入方式

本质上, 希望接入系统深入思考自己产品的权限模型

所以, 接入系统需要评估目前调用`新建关联接口`和`实例授权接口`的合理性, 是否可能会超过 10000 个 ID

### 4.1 如果现有的模型不合理, 需要优化为`范围`授权

以`范围`来管理权限, 避免简单粗暴的实例级别授权

可以借助`拓扑`和`属性`来进行权限管理
- 拓扑: 某个业务下的所有主机 / 某个模块下的主机
- 属性: 主机包含属性`system=linux/windows`, 配置权限支持 有`system=linux`的所有主机查看权限;

### 4.2 如果评估过是合理的`实例级别`权限管理

可以到权限中心`加白名单`, 继续使用

例如:
- PaaS: 目前 app 总的数量小于 2000 个, 个人用户 app 的数量不会超过 1000
- Job: 内部版 10 年时间脚本和作业个人创建的最多 3600 个


### 4.3 自行实现

**不推荐, 将无法使用统一的权限管理/鉴权等. 只有某些场景适合**

---

## 5. 超过 10000 个的后果

影响范围: 个人

- 这个人新建关联/实例授权接口报错
- 这个人新申请权限审批报错
- 这个人的鉴权可能非常慢(因为实例 ID 过多)

**超过之后, 需要接入系统自行解决!**
**超过之后, 需要接入系统自行解决!**
**超过之后, 需要接入系统自行解决!**

所以, 请仔细评估, 尽早处理掉有问题的权限模型!!!!!!

---

## 6. 如果超过 10000 限制该如何解决

**再次声明, 接入系统需要自行解决!**
如果接入系统没有仔细评估过权限模型, 导致无限制给单个用户授实例权限, 那么会有用户超过 10000 个 ID 的限制(随着时间推移, 最终会有越来越多的人超过限制)

解决步骤:
1. [拉取操作的策略列表](../Reference/API/08-Query/02-PolicyList.md)
2. 接入系统自行解析表达式, 根据 id 查询本系统, 能够合并的范围, 生成新的权限(范围授权)
3. 调用授权接口授权, 将新的权限写入系统 [资源拓扑授权/回收](../Reference/API/06-GrantRevoke/01-Topology.md)
4. 产品上废弃掉原有的 action, 使用新的 action 进行权限判断

---

## 7. 哪些场景不应该  `使用实例级别授权`  并且  `同步到权限中心`

> 如果接入系统自己知道 `有权限`, 就不需要授权到权限中心
> 使用范围授权

### 7.1 创建者

某些系统的场景, 创建者一定有权限; 例如, 应用的创建者一定有应用的增删改查权限;

- 解决方案 1: 接入系统先判断用户是否是否创建者, 如果是, 有权限, 非创建者再到权限中心鉴权.
- 解决方案 2: 记录资源的`creator=tom` ; 使用属性授权 `resource.creator=tom`, 进行鉴权是传递 resource 的属性即可

### 7.2 默认权限

系统有一批默认权限, 例如某个项目的管理员, 默认有项目的增删改查权限(新建一个项目后有 150 个默认权限), 这种默认权限是基于`角色`的不能变更的, 如果是`这个角色一定有这个权限`

此时, 应该在应用层面消化掉`默认权限`; 代码层面消化默认权限, 可能只需要一个函数, 如果注册到权限中心, 那么 1W 个项目会产生 150W 条默认策略，用户根本无法有效管理。

### 7.3 可以使用拓扑配置权限

某个模块 A 下有 2000 台主机, 如果是增删改查 4 个权限, 以主机维度授权, 需要 8000 条策略

- 解决方案: 配置模块授权,  `/模块,A/主机,*/`

### 7.4 可以使用属性配置权限

实例和实例之间是有某些共性的, 例如通过属性分类, 然后基于属性进行管理

例如主机有个`type`是表示其用途, 例如 `mysql/redis/es`, 可以按照 type 分类; 此时`数据库运维`管理`mysql`主机的权限, 不需要一台台授权

- 解决方案: 配置属性授权, `host.type=mysql`

如果本身资源没有这类属性, 但是权限管理又需要这类属性, 那么可以

- 解决方案: 实际使用过程中, 可以通过给资源打标签, 然后使用标签配置权限(本质上就是属性);

### 7.5 自己知道的权限

同`1. 创建者`/`2. 默认权限`类似, 如果接入系统能够知道, 或者通过计算知道权限, 就不需要走权限中心.

例如: 有系统 A 对象和 B 对象, 生成 C 对象, C 对象继承 A/B 的权限; 此时 A/B/C 均是十万级的; 每个人会拥有 10W 级别的实例权限

错误的做法: 定时的离线计算任务, 每天计算 A/B/C 的权限, 同步刷到权限中心;

- 解决方案: 实时计算`角色继承`关系得到权限; 或者优化模型使用`标签`/`属性`来管理权限

### 7.6 大规模批量导入（新建）场景

接入系统如果存在大规模批量导入（新建）实例的功能，比如资源池主机、模型实例，这种很容易导入 1000 台以上的实例，而且导入后需要赋予导入者（创建者）实例其他权限（比如删改查），这种场景`强烈建议不要`做大规模实例的赋权操作。

- 解决方案: 建议默认不赋予任何权限，去掉新建关联配置，用户需要额外的权限，可以单独申请。

---

## 8. 对外其他系统接入(非蓝鲸体系应用)

> 权限中心是一套`范围授权`+`有限实例授权`的系统

1. 无`新建关联接口`及文档
2. 无`实例授权接口`及文档
3. 可以`范围授权`(属性授权及拓扑授权)
4. 能通过页面进行实例权限申请(单次最多 20 个)
5. 对于高级用户(能深入评估权限模型, 并确认限制, 并自行承担误用超过 10000 个限制的后果)有文档支持 开通`新建关联`及`实例授权`的接口
