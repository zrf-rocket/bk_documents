# 有资源权限的用户列表

## 背景

系统接入权限中心后, 用户相关的权限都在权限中心统一维护. 

系统产品上, 用户登录后, 需要展示有资源权限的用户列表, 例如`有主机 1编辑权限的用户列表`.

## 困难

此时, 由于权限的来源非常复杂:
- 来自于个人实例权限`用户 1 - 主机 1`
- 来自于拓扑 `用户 2 - 业务 A 下的所有主机权限`, `主机 1 属于业务 A`
- 来自于属性 `用户 3 - 所有system=linux的主机权限`, `主机 1 的system=linux`
- 继承于部门 `部门 1 - 主机 1`, `用户 4 属于部门 1`
- 继承于组 `组 1 - 主机 1`, `用户 5 属于组 1`

并且, 由于权限本身是一个动态的表达式, 当 1000 个人配置策略, 会有 1000 条表达式, 需要从里面判断是否有`主机 1 编辑权限`的时候, 需要全部计算.

所以, 当前阶段是无法获取有某个资源权限的用户列表的.

## 解决方案 1

我们实现了一个基于检索引擎加实时计算的服务`iam-search-engine`

这个引擎会定期同步全量的策略数据, 进行分析, 之后索引.

基于这个服务, 我们可以使用`操作+具体资源`, 检索有资源权限的用户列表/组列表; 

注意, 如果个人权限继承自于部门或者组, 这个服务只能返回组, 不能展示组下部门/部门下成员等, 需要接入系统调用接口进一步查看;

注意, 这个服务只能查询 Top 100 的用户列表, 无法支持全量或分页(因为结果来自于多个引擎, 除了全文检索, 还有实时计算)

注意, 这个服务还在灰度测试中, 测试完成后进行出包并开源.

## 解决方案 2: 操作的用户列表

某些审计需求, 接入系统需要知道某个操作的有权限的 subject 列表. 或者只是为了一个计数.

此时, 可以通过 [policy list 查询接口](../../Reference/API/08-Query/02-PolicyList.md)

此时, 可以查询到一个操作的所有策略表达式及对应的`subject`;

注意, `subject`会重复, 需要接入系统自行去重/统计; 