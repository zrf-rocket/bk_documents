# 日志归档 


     日志归档，是将日志持久存储的一种功能，当需要查看日志的时候，可以从归档日志中按需回溯，查询完成后，即可销毁解压出来的归档日志。虽然ES支持冷热存储，但由于历史日志不经常查询，只是需要的时候才会去查询，例如半年审计时才会去查询一次，那么就会造成巨大浪费，使用ES冷存储是非常不划算的，我们应该使用更廉价的存储。

    日志平台支持将日志归档到COS，HDFS，本地存储这3种方式。可以将日志保存数月，数年，甚至几十年。因此，可以解决ES存储长久不够的窘境。



## 使用步骤

该功能使用的步骤如下：

1. 创建归档仓库：用于将归档日志存储的地方
2. 创建归档：按需将日志索引归档
3. 回溯数据：从归档数据中，指定索引，指定时间范围进行解压提取

## 数据生命周期

ES的存储，分为冷热数据，或者只有热数据的情况，日志归档是将过期后的日志，归档存储。其生命周期如下图所示

![](media/16620185864856.jpg)



## 创建归档仓库

### 1. HDFS仓库接入

ES集群需要安装HDFS插件 https://www.elastic.co/guide/en/elasticsearch/plugins/current/repository-hdfs.html

hdfs获取办法

* 公司内专门负责的团队
* 腾讯云HDFS https://cloud.tencent.com/product/chdfs
* 自建HDFS https://hadoop.apache.org/docs/r1.2.1/hdfs_design.html

通过上述方法获取到最终的HDFS uri地址 例如：`"hdfs://<host>:<port>/"`

如果配置了kerberos需要进行以下配置

配置方法

1. 用户需要在hdfs设置的kerberos中创建给es使用的principal, 然后导出对应的keytab文件
2. 将keytab放es每个节点对应的目录中去，
3. 然后需要在配置快照仓库的时候填写keytab所对应的principal

![](media/16620186915419.jpg)


### 2.COS仓库接入

> cos只能用于腾讯云ES或者安装了腾讯云COS插件的ES集群


cos仓库配置

> appid 腾讯云COS存储桶名称-后面的数字
> bucket为-前面的字母

![](media/16620187415730.jpg)

### 3.共享目录

有些本地可以挂载网络磁盘或者其他设备。 



## 创建归档

进入归档列表页面 点击归档

![](media/16620188034116.jpg)


配置归档

![](media/16620188182376.jpg)


完成归档

![](media/16620188257757.jpg)


## 归档回溯

### 创建回溯进行检索归档数据

进入回溯页面点击回溯

![](media/16620188717887.jpg)


配置回溯

![](media/16620188792260.jpg)


* 归档项：已归档的采集项

* 时间范围：指需要回溯的时间范围，例如查询2021-10-01到1021-10-31的日志，则会将这段时间所有的数据解压。

* 过期时间：从归档中解压出的日志，会写入到ES查询，如需要保留2天，则解压存储2天后，就会自动将解压日志删除。

* 结果通知人：归档回溯完毕后，发邮件通知完成

示意图如下所示

![](media/16620189391989.jpg)










