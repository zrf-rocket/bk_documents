# 混合云设施管控

## 情景

随着云计算浪潮的推进，多云管控逐渐成为趋势，多云间网络无法互通。

接下来看下蓝鲸是如何管控多云主机。

## 前提条件

- [部署完蓝鲸](../../../部署指南/产品白皮书/基础包安装/多机部署/quick_install.md)

## 术语解释

- **GSE Server** : [蓝鲸管控平台](../../..//管控平台/产品白皮书/产品简介/README.md)的后台服务，由文件分发、命令执行、数据上报三个模块组成。
- **GSE Proxy** : 跨云网络中，GSE Server 和跨云网络中被管控主机的代理，实现对跨云网络主机的管控。
- **Agent** : 运行在被管控主机上的代理程序，实现文件分发、命令执行以及数据上报。
- **VPC** : (Virtual Private Cloud)，私有网络，逻辑隔离的网络空间，每个私有网络内的服务资源内网互通，不同私有网络之间内网不通，但可通过新建**对等连接**来连通。
- **云区域** : 标识 VPC 网络，蓝鲸多云管控的关键字段，通过 租户 ID( bk_supplier_id )、云区域、IP 三者唯一标识主机。
- **直连网络** : 蓝鲸后台服务所在的网络，该网络下管控的主机与蓝鲸后台互通。

## 操作步骤

- 梳理网络拓扑
- 管理直连网络区域的主机
- 管理跨云网络区域的主机

### 梳理网络拓扑

以下是一个经典的多云管控网络拓扑图。

蓝鲸所在的网络为 `VPC 1` ，通过`直连方式`管理该网络区域的主机，通过带有外网的 `GSE Proxy` 来管理公有云的主机（网络为 `VPC 2` 和 `VPC 3`）。

![-w1093](../assets/15658731519358.jpg)

> 上图是从管控角度绘制的网络拓扑图。
> 
> 在跨云管控的场景下，在蓝鲸所在 VPC 1 网络下发安装 Agent 的行为，还需要蓝鲸后台的 [Nginx 模块](../../../部署指南/产品白皮书/基础包安装/环境准备/get_ready.md) 具备外网 IP，供 VPC 2 和 VPC 3 网络的 GSE Proxy 下载 Proxy 和 Agent 安装包。

### 管理直连网络区域的主机

先介绍如何管控蓝鲸后台服务所在网络（也称直连网络）的主机。

#### 安装蓝鲸 Agent（直连区域）

请参考 [节点管理文档：直连区域 安装 Agent](../../../节点管理/产品白皮书/QuickStart/DefaultAreaInstallAgent.md)

#### 命令执行和分发文件测试

使用作业平台`执行脚本`和`分发文件`做测试。

![-w2020](../assets/blueking_execute_push_file.gif)

### 管理跨云网络区域的主机

接下来介绍，如何管控跨云网络（例如 VPC 2 和 VPC 3）的主机。

#### 安装蓝鲸 Agent（自定义云区域）

请参考 [节点管理文档：自定义云区域 安装 Agent](../../../节点管理/产品白皮书/QuickStart/CustomCloudAreaInstallAgent.md)

#### 命令执行和分发文件测试

使用作业平台`执行脚本`和`分发文件`做测试。

{% video %}https://bkdocs-1252002024.file.myqcloud.com/ZH/6.0/bk_solutions/CD/Automation/media/bk_nodeman.mp4{% endvideo %}

## 扩展阅读

### 多级级联：管理隔离网络的主机

在部分企业网络环境中，存在 `VPC 1（蓝鲸所处网络）` 和 `VPC 3` 不互通，但需要管控 VPC 3 网络主机的场景，如下图：

![-w1274](../assets/15658731695414.jpg)

这时候，需要企业网络环境中，存在一个 VPC 2 的网络， 通过申请网络策略，连通 VPC1 和 VPC 3 中的指定（最小策略，安全）服务器。

这时需要使用蓝鲸管控平台的**多级级联**功能， VPC 3 网络中的主机与 GSE Proxy 2 互通，GSE Proxy 2 通过 上联 GSE Proxy 1 与 蓝鲸 GSE Server 通信。

> `多级级联`功能尽请期待。
