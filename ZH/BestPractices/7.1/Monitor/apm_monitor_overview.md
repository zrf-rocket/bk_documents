# 开启APM监控

观测场景-应用监控



## 什么是APM

APM（Application Performance Monitoring）即应用性能监控 ， 通过应用软件之间的服务调用来分析软件的问题，可以更细粒度的监控和满足用户更好的体验。APM具体要解决三方面的问题

![](../BASIC/16618503644108.jpg)

### 用户排障流程

用户已经明确知道有故障，进行精准的问题复现和定位。

* 第一种： 只知道有问题的时间段和service，需要进行范围缩小和上下游查找。调用链查询方式。（内部错误的筛选项）
* 第二种： 已经拿到明确的tracid进行具体的查看，有可能拿到的traceid断链了，或者没有采集上来。

    * 需要进行染色（明确哪个traceid必需采集上来，或者具体的某个userid ， vip类型必需采集不丢弃）
    * 实时进行分析（不采样，不丢数据 5分钟）
* 第三种：明确是哪个instance有问题， 开始进行反向查看，具体问题在哪？
* 第四种：明确是知道哪个service有问题，再对service进行查看包括instance

### 常规巡检流程

用户还不知道自己的服务状况，相关监控还未完善，或者监控告警之后需要进行整体的查看。

* 查看整体的情况，看是否符合预期。 拓扑、黄金指标、TOP的数据。
* 对架构的诊断： Application拓扑 、慢的环节

    * SQL分析
    * 热key、大key（response的大小）

* 版本发布后查看版本的变化
* 报表（用户定义用户关心的内容）
* 错误日志统计、日志聚类、日志分析

### 主动告之问题

用户接入还未有人投诉，通过指标数据和智能监控数据统计主动告之用户系统状况

* application维度
* service维度
* 接口维度
* instance维度
* 错误日志
* 自定义维度

## 相关概念

#### 业务 Business 

管理和资源的物理隔离，配置平台中最基本命名空间

#### 应用 Application

应用一般是拥有独立的站点，由多个Service共同组成提供完整的功能，拥有独立的软件架构。 从技术层面来说是Trace数据的存储隔离，在同一个应用内的数据将进行统计和观测。

#### 服务 Service 

微服务中独立的模块，独立完成一个功能，一般可以认为相同的程序构成的为一个Service，那么构成的每个进程为服务实例。

#### 接口 Resources

应用程序中处理一次独立的访问请求的过程，包括了HTTP的请求，DB的查询，中间件操作等等。

#### 错误 Errors

当一个异常的发生导致了此次的接口请求为错误，在字段中会记录错误的状态，`span.status_code`， 所以Span中有日志不代表一定是错误，也不是Status是错误就一定有日志，两者没有绝对关系，主要看输出的设置。不过建议按规范使用status_code，否则平台无法统计出相应的内容。 

#### Trace & Span

核心的两个概念和数据，就是基于TraceID和Span的数据信息进行的汇总统计。 

* Trace： 记录经过分布式系统的请求活动，一个trace是spans的有向无环图
* Span ： 一个trace中表示一个命名的，基于时间的操作。Spans嵌套形成trace树。每个trace包含一个根span，描述了端到端的延迟，其子操作也可能拥有一个或多个子spans。

#### Opentelemetry

OpenTelemetry合并了OpenTracing和OpenCensus项目，提供了一组API和库来标准化遥测数据的采集和传输。OpenTelemetry提供了一个安全，厂商中立的工具，这样就可以按照需要将数据发往不同的后端。蓝鲸监控的APM的SDK完全兼容Opentelemetry的SDK即能力。 

#### 关系

* 一个业务有多个应用
* 应用之间有数据隔离
* 一个应用包括了N个Service
* 一个Service包括了N个服务实例

## APM应用创建

1. 需要创建一个APM应用 并设置应用名称以及应用英文名
![](../BASIC/16618528691936.jpg)

2. 选择插件和对应的语言环境，提供相应的帮助文档
3. 选择存储并进行存储设置


## SDK上报数据

创建完应用后，拿着生成的Token信息，按上报地址，基于不同的语言接入进行相应的数据上报。 

具体查看各语言的[SDK上报](../../../Monitor/3.8/UserGuide/ProductFeatures/integrations-traces/otel_sdk_golang.md)


## 查看数据

数据上报成功后，在 数据检索-> Trace检索 最快可以看到数据， 观测场景 -> 应用监控 需要10分钟的统计周期以上才会有相应的数据查看。 

### Trace调用链查看

![](../BASIC/16618530415573.jpg)


### 应用拓扑查看

![](../BASIC/16618530630491.jpg)





