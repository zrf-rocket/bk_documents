# 通知收敛和汇总机制

为了避免短时间内大量产生告警事件导致的告警风暴，监控平台对告警通知进行了收敛及汇总处理。

## 告警收敛

为了避免相同的告警在每个检测周期都产生通知，策略配置中可以设置通知间隔，两次通知之间的告警将会被收敛。

![-w2021](media/image-20200206210333199.png)

![-w2021](media/image-20200206211833279.png)

## 告警抑制

高级别的告警会抑制低级别的告警。

1. 如果产生了高级别告警，同维度低级别告警会立即恢复。
2. 如果存在高级别告警，低级别告警不会产生

## 告警汇总

对一段时间内的多条告警通知按一定规则进行分类后汇总发送。

### 通知分配

告警通知将会被进行两级分类。

首先，单条的告警通知会按以下信息分类，信息相同的会被分配到相同分类。

同策略产生的同级别同维度的告警通知将会被归为一类，这里我们把它称为**同维度组**。

1. 业务 ID(bk_biz_id)
2. 通知接收人(notice_receivers)
3. 通知方式(notice_way)
4. 通知类型(notice_type)
5. 告警策略(strategy_id)
6. 告警级别(level)
7. 维度哈希(dimension_hash)

然后，上述的分类再按以下信息分类，统计每个分类中的有多少个同维度组。

同业务、同数据来源、同级别的类会被归为一类，这里我们把它称为**多策略组**。

1. 通知类型(notice_type)
2. 通知接收人(notice_receivers)
3. 通知方式(notice_way)
4. 业务 ID(bk_biz_id)
5. 数据源类型(data_source)
6. 告警级别(level)

### 触发发送任务

通知分类完毕后，会尝试触发发送任务，有下列三种发送任务：

1. 立即发送

   当同维度组的通知没有进入任何汇总状态时，直接触发延迟一秒的发送任务。之所以不是直接发送单条的告警，是为了当短时间内涌入大量告警时，发出的第一条告警能够带上足够多的告警。

   任务执行时汇总发送这个同维度组中的 120 秒内的未发送通知。

2. 同维度汇总发送

   当同维度组中的待发送通知数达到**同维度汇总阈值**时，该同维度组进入汇总发送状态，触发一次延迟 60 秒的发送任务，任务未执行时，该同维度组将不会触发**立即发送**。

   任务执行时汇总发送该同维度组中的**同维度汇总时间窗口**秒内的未发送通知，然后将发送的通知标记为已发送。

3. 多策略汇总发送

   当多策略组中的同维度组数量达到阈值**多策略汇总阈值**时，该多策略组进入汇总发送状态，触发一次延迟 60 秒的发送任务，任务未执行时，该多策略组中的同维度组将不会触发任何发送任务。

   任务执行时汇总该多策略组中的所有同维度组中**多策略汇总时间窗口**秒内的未发送通知，然后将通知标记为已发送。

> 上述说明中提到的**汇总阈值**及**汇总时间窗口**，管理员可以在动态全局配置中进行调整。

### 通知内容

1. 同维度汇总和多策略汇总的通知模板是不同。
2. 某些通知渠道(如：短信)的单条消息长度受限。当通知消息达到单条消息长度限制时，某些通知模板变量会进入省略模式，尽量减少通知消息的长度，但并不能保证通知消息一定小于单条消息长度限制。
   * content.target
   * alarm.target
   * content.dimension
   * alarm.dimension

## 语音告警

由于语言告警的特殊性，语音告警的汇总逻辑比较特殊，它会保证 2 分钟内，无论有多少语音告警通知，同一组人只会接到一条电话告警，其余的语言告警会被丢弃。

因此只有重要的告警才建议配置电话告警。
