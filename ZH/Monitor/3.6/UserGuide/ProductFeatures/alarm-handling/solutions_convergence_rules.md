# 防御规则列表说明


介绍自愈目前收敛的几种模式，并用现有的一些通用收敛规则举例说明其用法。 希望收敛规则能满足你各式各样的需求，并且在配置好后，让你会忘了它的存在。 目前收敛的维度内置有：告警级别，触发信号，套餐配置。通知内置的维度还包含 ： 通知人员，通知方式

## 异常防御审批

满足防御规则的每个处理动作，都会产生一个审批单据，让负责人审批决定是否需要执行，如同意则继续执行，拒绝或者超时30分钟未审批则直接收敛不处理

* 举例：在5分钟内触发N条，进行 异常防御审批收敛

* 解释：如果5分钟内同策略触发了 M (M>N) 次套餐，则前 N 次会正常执行套餐，第 N+1 ~ M 次将在流程服务分别产生一个审批单据。此处共产生 M - N 个单据，每个单据对应一次套餐执行

## 执行中跳过

触发规则后，如果有满足规则的其他告警正在自愈， 则跳过当前告警，直接设置为忽略。

可用于避免重复处理。

* 举例：在5分钟内触发N条，进行 执行中跳过 收敛

* 解释：如果5分钟内同策略触发了 M (M > N) 次套餐，前 N 次会正常执行，第 N+1 ~ M 次将查询当前策略和主机是否存在正在执行的套餐，如果存在，则直接跳过执行，否则正常执行。使用该收敛方式时，实际执行次数取决于任务的实时状态，会在 N~M 次不等

## 执行中等待

触发规则后，如果有满足规则的其他告警正在自愈，则等其他告警自愈完成后再继续处理当前告警。

可用户互斥的告警处理，或有先后顺序依赖的告警处理。

* 举例：在5分钟内触发N条，进行 执行中等待 收敛

* 解释：如果5分钟内同策略触发了 M (M > N) 次套餐，前 N 次会正常执行，第 N+1 ~ M 次将查询当前策略和主机是否存在正在执行的套餐，如果存在，则等待上次执行完成，否则正常执行。产生的结果是，实际共执行 M 次套餐，其中前 N 次并行执行，第 N+1 ~ M 次串行执行

## 成功后跳过

触发规则后，如果有满足规则的其他告警自愈成功，则跳过当前告警。失败的话则继续自愈处理。

可用于实现失败重试。

* 举例：在5分钟内触发N条，进行 成功后跳过 收敛
* 解释：如果5分钟内同策略触发了 M (M > N) 次套餐，前 N 次会正常执行，第 N+1 ~ M 次将查询上一次的执行结果，如果是执行中，则等待；如果是失败，则执行套餐，如果是成功，则跳过。产生的结果是，5分钟内最多有 N 次执行成功

## 超出后忽略

触发规则后，超出数量的告警将会收敛不处理

触发规则后，如果有满足规则的其他告警自愈成功，则跳过当前告警。失败的话则继续自愈处理。

可用于实现失败重试。

* 举例：在5分钟内触发N条，进行 超出后忽略 收敛
* 解释：如果5分钟内策略触发了 M (M > N) 次套餐，前 N 次会正常执行，第 N+1 ~ M 次跳过执行。即5分钟内实际最多执行N次

## 超出后汇总 (通知套餐内置)

遇到相同的策略、监控维度、告警级别、触发信号、通知方式、通知人员，在2分钟内超过1条告警，将不再继续发送通知，并在1分钟后发送汇总通知， 如果生成了跨策略汇总事件，则当前汇总通知会受到抑制。

## 同业务汇总（通知套餐内置）

一级收敛：即超出后汇总收敛

默认在2分钟内，达到3个及以上的一级收敛（相同业务，相同接收人员，相同通知方式，相同告警级别，相同触发信号， 收敛时间窗口和数量可以在全局配置中进行自定义配置），将进行同业务汇总收敛（二级收敛）

* 举例：

    * 策略A：2分钟内触发了3次通知，第1次会正常通知，并打开一个汇总窗口，第2次和第3次会跳过执行
    * 策略B：2分钟内触发了2次通知，第1次会正常通知，并打开一个汇总窗口，第2次会跳过执行
    * 策略C：2分钟内触发了3次通知，第1次会正常通知，并打开一个汇总窗口，第2次和第3次会跳过执行
这时候会有两种情况

* 所有策略都打开了告警风暴开关
    * 业务汇总触发，将在1分钟后发送1个业务汇总通知，告警内容同时包含 A(2~3),B(2),C(2~3)
* 其中任一策略关闭了告警风暴开关
    * 将在1分钟后发送3个汇总通知，其中一个告警内容包含 A(2~3)，一个告警内容包含B(2)，一个告警内容包含C(2~3)

