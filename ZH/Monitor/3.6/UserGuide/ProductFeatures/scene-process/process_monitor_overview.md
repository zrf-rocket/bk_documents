# 开启进程监控

进程相关的指标数据采集和监控是最常用的基本的监控能力。 

进程监控有三种方式：

1. 基于CMDB的进程配置，默认bkmonitorbeat会进行采集。
2. 基于动态进程采集插件（内置的），会按用户的配置需求进行采集。
3. 自定义插件再采集相关数据。


## 工作原理


![](media/16618456580513.jpg)

### 基于CMDB的进程配置

蓝鲸的配置平台即 CMDB 可以集中式的管理所有的配置信息，比如基于主机信息和进程信息就可以有效的进行相应的监控，是推荐的用法，这样相关的周边系统也可以一同协作。 

工作原理：CMDB 配置了进程信息后会主动下发到服务器上 (hostid文件)，监控就是利用该配置进行的进程采集。所以需要确保 CMDB 的配置正确。

```
bkmonitorbeat进程监控逻辑：
1.CMDB主机-服务实例 配置端口
2.gse server从CMDB同步端口数据
3.gse_agent收到数据写入到本机/var/lib/gse/host/hostid
4.bkmonitorbeat通过inotify监听/var/lib/gse/host/hostid文件变化，读取需要监听的进程端口信息
5.对指定的端口从Linux内核通过netlink读取监听状态，将进程端口数据上报
6.上报的数据中，未监听的端口产生告警
```

进程名判断会按顺序对三个proc下的内容进行匹配,可以直接使用 `readlink -f  /proc/${pid}/exe` 获取。

1. `/proc/$pid/status`中的Name字段
2. `/proc/$pid/exe`指向的文件名
3. `/proc/$pid/cmdline`中，空白符分割后的第一个元素

只要任意一个有命中，则认为进程匹配成功

指标数据来源于 `/proc/$pid/stat`

更具体的使用查看[基于CMDB进程监控](./process_cmdb_monitor.md)

### 基于动态进程采集插件

动态进程采集插件是平台内置的一个插件配置能力，依赖bkmonitorbeat，当采集任务配置好下发到目标机器后，会基于采集的任务信息进行工作。

* 好处：一些无法在CMDB里面配置的进程信息，如主进程fork出来的进程可以进行匹配。
* 坏处：配置只在监控生效，其他系统没有办法复用。 

更具体的使用查看[基于动态进程插件采集进程监控](./process_pattern_monitor.md)


### 自定义插件进行进程监控

自定义插件是最灵活和平台最通用的方式，当平台没有提供默认的采集的能力下都可以使用插件来进行扩展。 

具体的使用方法参照[插件的制作和采集](../integrations-metric-plugins/plugins.md)

