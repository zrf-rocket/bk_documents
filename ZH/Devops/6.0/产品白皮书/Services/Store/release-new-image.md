# 发布一个容器镜像

## 准备容器镜像

若没有镜像，请参考[构建并托管一个 CI 镜像](docker-build.md)

## 发布容器镜像

### 入口

工作台->容器镜像->关联镜像
![png](../../assets/store-image-entry.png)

### 关联镜像

![png](../../assets/store_image_relate.png)

1. 镜像在研发商店中的唯一标识，不重名即可
2. 镜像发布过程中，可以在此调试项目下，验证镜像功能是否正常。建议使用专用的测试项目验证
3. 若为私有镜像，请在凭证管理创建一个凭证，关联到此镜像。执行时，系统使用此凭证去拉取镜像

### 上架/升级镜像

#### 入口如下

![png](../../assets/store_image_upgrade_entry.png)

#### 填写基本信息

![png](../../assets/store_image_upgrade_1.png)
![png](../../assets/store_image_upgrade_2.png)

1. 镜像库host
    - 若为docker hub镜像，可以不填，或者填 docker.io
2. 镜像名称，包括镜像命名空间
3. 镜像tag
4. 凭证：私有镜像需要指定访问的凭证
5. Dockerfile：将展示在研发商店中，供用户了解镜像细节

当升级镜像时，有三种升级模式：
![png](../../assets/store_image_upgrade_3.png)

1. 非兼容式升级：
    - 镜像功能逻辑发生重大变更，和老版本不兼容时使用
    - 此类型版本发布后，已使用该镜像的流水线不会自动升级版本，需用户手动修改版本号
    - 主版本号 +1
2. 兼容式功能更新：
    - 镜像功能更新或新增(不影响已使用用户)时使用
    - 此类型版本发布后，已使用该镜像且版本号选为[主版本.latest]的流水线自动使用新版本，无需手动编辑流水线
    - 次版本号 +1
3. 兼容式问题修正：
    - 镜像功能兼容旧版本，仅做问题修正
    - 此类型版本发布后，已使用该镜像且版本号选为[主版本.latest]的流水线自动使用新版本，无需手动编辑流水线
    - 修正号 +1

#### 验证镜像

提交发布后，可以在调试项目下验证镜像功能是否满足预期
![png](../../assets/store_image_release_info.png)

1. 测试：点击后跳转到调试项目的流水线服务下，可以使用此镜像执行流水线Job，验证功能是否满足预期
2. 若发现问题，重新推送镜像后，重新验证并测试
    - 验证镜像步骤，仅校验镜像是否能成功拉取，功能是否正常还需要发布者自行测试
3. 测试OK后，手动继续发布流程，将镜像发布到研发商店，供其他用户/项目使用
