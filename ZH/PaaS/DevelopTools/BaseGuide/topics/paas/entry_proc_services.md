# 进程服务说明

## 简介

在 [应用进程和 Procfile](./process_procfile.md) 中，我们介绍了如何为应用定义进程以及如何管理进程。

但进程是无法单独为他人提供服务的，我们需要配置“访问主入口”与“进程服务”来将应用进程暴露给应用内部与外部用户。

本文是“访问主入口”与“进程服务”的相关介绍。

## 访问主入口

每个蓝鲸应用默认拥有“预发布”与“正式”两个不同的部署环境，而每个环境都拥有一个“访问主入口”。当用户通过浏览器请求各环境外部地址时，请求将会被转发到该环境“访问主入口”所指向的目标服务。

默认情况下，各环境“访问主入口”被设置为 **web** 进程的 **5000** 端口。同时，为了方便进程监听该默认端口，平台也会在应用运行环境中注入一个名为 `PORT` 的环境变量，其值为 5000。详见 [内置环境变量说明](./builtin_configvars.md)。

### 如何修改

> **注意：在修改应用主入口前，请确保你已经完全理解本文档，不当操作可能会影响应用正常访问。**

如果你想把某个环境的“访问主入口”切换到其他进程或其他端口，可以进入“访问入口”页面的“进程服务管理”模块。

- 首先，参考本文档后面的部分调整好进程服务的端口规则
- 然后，点击进程右侧的下拉菜单，将主入口切换为你需要的进程服务端口
- 访问应用，完成切换

## 进程服务

进程服务是应用进程完成内部通信和外部暴露的核心概念，它的主要作用如下：

- 在应用内部，通过 “进程服务名称 + 端口号” *（如 http://default-bkapp-amazingblues-stag-web:8080）* 来进行内部通信
- 设置某进程服务端口为“访问主入口”，可以将服务对外暴露

### 如何查看与修改

进入“访问入口”页面的“进程服务管理”模块，可以查看当前应用的进程服务情况，并对其进行调整。
每个进程服务下可以设置一个或多个端口规则，规则里各字段含义如下：

- **名称**：用于区分端口规则的名字，同一进程下不能重复
- **协议**：TCP / UDP
- **服务端口**：在应用内通过“服务名称”访问的端口号，同一进程下不能重复
- **进程内端口**：进程真正监听的端口号，比如 web 进程通过 "gunicorn -b :8080" 启动，那么它所监听的进程内端口就是 8080

默认情况下，平台会为每一个进程创建一条默认规则：

- 名称：http
- 协议：TCP
- 服务端口：80
- 进程内端口：5000

这条默认规则可以保障新应用在第一次部署后，不用配置任何规则也直接被浏览器访问。

### 如何通过进程服务进行内部通信

随着需求的复杂化，蓝鲸应用的软件设计逐步由单体式应用向微服务架构演化。微服务架构是一种模块化的解决方案。在功能不变的情况下，应用被分解为多个可管理的应用进程。

微服务的架构下，各个进程是独立部署的，进程间的通信方式不同于单体式应用，并不能简单地通过调用本地函数，或者借助共享内存等方式实现, 而是需要一套完整的路由机制来完成通信。

## 进程间如何通信

进程间通信需要以下几个步骤：

- 在 Procfile 中定义进程，并监听对应端口，如 `backend: gunicorn -b :8080`，表示让 backend 进程监听 8080 端口
- 进入“访问入口” -> “进程服务管理” 模块，在 backend 进程下添加新端口规则并保存，比如：
  - 名称：default
  - 协议：TCP
  - 服务端口：8081
  - 进程内端口：8080
- 通过页面上显示的 backend 进程服务名称，如 “http://default-bkapp-app-stag-backend:8081” 访问服务

> 注：服务名称生成规则：{region}-bkapp-{app_code}-{env}-{process_type}
>
> Important: 端口规则的“服务端口”字段，仅影响它的模块内通信地址。即便某端口被设置成了主入口，模块的外部访问地址的端口号也不会受其影响。
> 
> 举个例子，如果一个模块的外部访问地址为 `foo.com`，你把某服务端口为 8080 的规则设置为“访问主入口”后，模块的外部访问地址仍然是 `foo.com`，不会变成 `foo.com:8080`。
