# 网关认证方案

API 网关支持对请求来源进行认证，包括：**蓝鲸应用认证**和**用户认证**。

请求网关 API 时，若网关 API 要求认证应用，但认证应用失败，或要求认证用户，但认证用户失败，网关将直接响应错误，不会请求后端接口；
否则，网关将请求后端接口，并将认证信息传递给后端接口，以便后端接口获取当前请求的蓝鲸应用或用户。

## 认证请求来源

网关认证请求来源包括**蓝鲸应用认证**和**用户认证**。请求网关 API 时，认证信息应放在请求头`X-Bkapi-Authorization`中，值为 JSON 格式字符串，例如：
```
X-Bkapi-Authorization: {"bk_app_code": "x", "bk_app_secret": "y", "bk_token": "z"}
```

## 蓝鲸应用认证

蓝鲸应用认证支持的方案：
- bk_app_code + bk_app_secret：直接使用蓝鲸应用账号认证应用。可参考[获取蓝鲸应用账号](../use-api/bk-app.md)


## 用户认证

蓝鲸用户认证支持的方案:
- bk_token：使用用户登录态认证用户，具体请参考[获取蓝鲸用户身份](../use-api/bk-user.md)。

## 发送给后端接口的认证信息

API 网关为每个网关分配不同的一对公钥、私钥，网关请求后端接口时，将当前请求的蓝鲸应用、用户信息，
使用网关私钥进行签名，生成 JWT 格式的加密串放到请求头`X-Bkapi-JWT`中。

后端接口可以利用网关公钥，对请求头`X-Bkapi-JWT`进行解密，如果解密成功，则
- 后端接口可以验证，请求一定来自于 API 网关
- 后端接口可以从解析结果中，获取当前请求的蓝鲸应用和用户信息

网关公钥，可以在网关管理页，菜单**基本设置**下的**基本信息**页查看，可通过**API公钥(指纹)**后的**复制**或**下载**获取。

X-Bkapi-JWT 内容解析后的样例如下：
```json
{
    "app": {                     # 蓝鲸应用信息
        "version": 1,
        "app_code": "app-test",  # 蓝鲸应用ID，即 bk_app_code，未通过认证时，值可能为空字符串
        "verified": true         # 蓝鲸应用是否通过认证，true 表示通过认证，false 表示未通过认证
    },
    "user": {                    # 蓝鲸用户信息
        "version": 1,
        "username": "admin",     # 用户名，未通过认证时，值可能为空字符串
        "verified": true         # 蓝鲸用户是否通过认证，true 表示通过认证，false 表示未通过认证
    },
    ...
}
```
