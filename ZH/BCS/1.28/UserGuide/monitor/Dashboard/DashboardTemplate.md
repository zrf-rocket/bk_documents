# Dashboard 模板使用技巧

## 什么是模板变量

模板允许更多交互方式，如动态的仪表板。用户可以在标准查询中使用变量代替硬编码，比如 cluster_id，namespace 和 container_id 名称等。变量显示为仪表板顶部的下拉选择框。通过这些下拉菜单，用户可以轻松更改仪表板中显示的数据。

![-w2021](./_image/2020-11-17-10-50-29.jpg)


变量显示为仪表板顶部的下拉选择框。它具有当前值和一组选项。该选项是一组可供选择的值。

## 如何添加变量

在每个 Dashboard 右上角，可以看到一个`设置`按钮，点击进入设置页面。

![-w2021](./_image/2020-11-17-11-00-35.jpg)

在 **Variables -> Add variable** 处添加变量。

![-w2021](./_image/2020-11-17-10-57-10.jpg)

可以使用查询语法动态添加变量值。

![-w2021](./_image/2020-11-17-10-58-14.jpg)

## 基本变量说明

选项 | 描述
------- | --------
*Name* | 变量的名称，这是在查询中引用变量时使用的名称。必须是唯一的，不包含空格，建议是使用英文字母，下划线表示。
*Label* | 此变量的下拉列表时展示的名称。
*Hide* | 隐藏下拉选择框的选项。
*Type* | 定义变量类型。


### 变量类型

类型 | 描述
------- | --------
*Query* | 此变量类型允许用户编写数据源查询，该查询通常返回变量名称，标记值或键的列表。例如，返回 cluster_id，pod_name 或 namespace 的查询。
*Interval* | 此变量可表示时间跨度。不是按时间或日期直方图间隔对组进行硬编码，而是使用此类型的变量。
*Datasource* | 此类型允许用户快速更改整个仪表板的数据源。如果用户在不同的环境中有多个数据源实例，则非常有用。
*Custom* | 使用逗号分隔列表手动定义变量选项。
*Constant* | 定义隐藏常量。对于要共享的仪表板的度量标准路径前缀很有用。在仪表板导出期间，常量变量将变为导入选项。
*Ad hoc filters* | 非常特殊的变量，目前仅适用于某些数据源，InfluxDB 和 Elasticsearch。它允许用户添加键/值过滤器，这些过滤器将自动添加到使用指定数据源的所有度量标准查询中。

### 查询选项

此变量类型是最强大和最复杂的，因为它可以使用数据源查询动态获取其选项。

选项 | 描述
------- | --------
*Data source* | 查询的数据源目标。
*Refresh* | 控制何时更新变量选项列表（下拉列表中的值）。在仪表板上加载将减慢仪表板负载，因为在初始化仪表板之前需要完成变量查询。如果变量选项查询包含时间范围过滤器或取决于仪表板时间范围，则仅将此设置为“ 开启时间范围更改”。
*Query* | 数据源特定的查询表达式。
*Regex* | 正则表达式用于过滤或捕获数据源查询返回的名称的特定部分。可选的。
*Sort* | 在下拉列表中定义选项的排序顺序。已禁用表示将使用数据源查询返回的选项顺序。

### 查询表达式

每个数据源的查询表达式都不同，下面是 Prometheus 的表达式，其他请参考 grafana 官方文档

| Name                                     | Description                                                                    |
| -------------------------------- |------------------------------------------------------------ |
| `label_names()`                     | 返回 label 的名称列表                                                    |
| `label_values(label)`             | 返回每个 `metrics` 中标签的标签值列表。               |
| `label_values(metric, label)`  | 返回指定 `metrics` 标签的标签值列表。                  |
| `metrics(metric)`                  | 返回与指定的 `metric` 正则表达式匹配的指标列表。  |
| `query_result(query)`            | 返回查询的 Prometheus 查询结果列表。                |

需要注意的一点是，查询表达式可以包含对其他变量的引用，实际上可以创建链接变量。Grafana 将检测到这一点并在其中一个变量包含上一级变量时自动刷新变量。

### 区间变量

使用 Interval 类型创建表示时间跨度的变量（例如`1m`，`1h`，`1d`）。还有一个特殊 auto 选项会根据当前时间范围而改变。用户可以指定当前时间范围应分多少次以计算当前 auto 时间跨度。

此变量类型可用作按时间分组的参数（对于 InfluxDB），日期直方图间隔（对于 Elasticsearch）或作为汇总函数参数（对于 Graphite）。

## 全局内置变量说明

Grafana 具有全局内置变量，可以在查询编辑器中的表达式中使用。

### $__interval 变量

这个$__interval 变量类似于上面描述的`auto`interval 变量。它可以用作按时间分组的参数（对于 InfluxDB），日期直方图间隔（对于 Elasticsearch）或作为汇总函数参数（对于 Graphite）。

Grafana 自动计算可用于在查询中按时间分组的间隔。当数据点多于图表上显示的数据点时，可以通过更大的间隔分组来提高查询效率。在查看 3 个月的数据时，分组比 1 天比 10 分更有效，图表看起来相同，查询会更快。$__interval 使用时间范围和图形（像素数）的宽度来计算。

近似计算： `(from - to) / resolution`

例如，当时间范围为 1 小时且图形为全屏时，则可以计算间隔`2m` - 以 2 分钟为间隔对点进行分组。如果时间范围是 6 个月并且图表是全屏，则间隔可能是`1d`（1 天） - 点按天分组。

### $__interval_ms 变量

此变量是以`$__interval`毫秒为单位的变量（而不是格式化字符串的时间间隔）。例如，如果`$__interval`是 20m，那么`$__interval_ms`是 1200000。

### $timeFilter 或 $__timeFilter 变量

$timeFilter 变量返回当前选定的时间范围作为表达。例如，时间范围间隔`Last 7 days`表达式为`time > now() - 7d`。

这在 InfluxDB 数据源的 WHERE 子句中使用。在查询编辑器模式下，Grafana 会自动将其添加到 InfluxDB 查询中。必须在文本编辑器模式下手动添加：`WHERE $timeFilter`。

### $__name 变量

此变量仅在 Singlestat 面板中可用，可以在 `选项` 选项卡上的前缀或后缀字段中使用。变量将替换为系列名称或别名。

### 其他参考

- [Elasticsearch Templated Dashboard](http://play.grafana.org/dashboard/db/elasticsearch-templated)
- [InfluxDB Templated Dashboard](http://play.grafana.org/dashboard/db/influxdb-templated-queries)
